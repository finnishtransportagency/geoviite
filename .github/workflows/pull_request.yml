name: MAIN PULL REQUEST

run-name: ${{ github.actor }} wants to merge ${{ github.ref_name }}

on:
  pull_request:
    branches: [main]
    paths-ignore:
      - 'README.md'

jobs:
  runner-job:
    runs-on: ubuntu-latest

    services:
      geoviite-postgres:
        image: 'postgis/postgis:15-3.3-alpine'
        env:
          POSTGRES_PASSWORD: 'dev-geouser-password'
          POSTGRES_USER: 'dev-geouser'
          POSTGRES_DB: 'geoviite'
          DB_NAME: 'geoviite'
          DB_USER: 'dev-geouser'
          DB_PASSWORD: 'dev-geouser-password'
        ports:
          - '127.0.0.1:5436:5432'

    steps:
    - name: Download repository on the runner
      uses: actions/checkout@v3

    - name: Configure JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2

    - name: Execute Gradle build
      run: |
        cd infra
        ./gradlew build -x test

    - name: run unit tests in infra (backend)
      run: |
        cd infra
        ./gradlew cleanTest test --tests "*Test"

    - name: run integration tests in infra (backend)
      # env-muuttujat, toinen vaihtoehto: githubille oma application-yml? (tai käytä test-yml?)
      # https://stackoverflow.com/questions/59741629/how-to-pass-environment-variables-to-the-gradle-wrapper-build-using-only-command
      run: |
        cd infra
        DB_NAME=geoviite DB_USER=dev-geouser DB_PASSWORD=dev-geouser-password POSTGRES_DB=geoviite POSTGRES_USER=dev-geouser POSTGRES_PASSWORD=dev-geouser-password ./gradlew cleanTest test --tests "*IT"
